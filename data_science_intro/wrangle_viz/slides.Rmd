---
title: "Data Wrangling and Visualization"
author: "Phil Chodrow"
date: "8/15/2017"
output: 
  ioslides_presentation:
    logo: http://colinpawlowski.com/assets/images/ORC_logo_horizontal.png
    css: ../slide_style.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, out.width = "300px", out.height = "350px", fig.align="center", cache = TRUE)
library(tidyverse)
```

# Introduction

1. The Case
2. Learning Goals
3. The Data Science Process
4. The Tidyverse

## The Case

- AirBnB is a website that allows hosts to rent their homes to travelers and tourists. 
- AirBnB can maximize its business by ensuring it has enough listings in different neighborhoods. 
- AirBnB has asked you, a data analytics consultant, to help them identify neighborhoods in Boston where they should focus on recruitment through advertising and incentives. 
- They have given you a complex, multi-part data set to answer this question. 

## What We'll Do This Morning

- Work with some real data to answer an impactful question.
- Create elegant and informative visualizations for a business intelligence (BI) [dashboard](https://philchodrow.github.io/data_science_intro/wrangle_viz/dashboard.html).
- Make recommendations based on our findings.

## Exercise 0 

> 1. Look left.
> 2. Look right.
> 3. Pick a partner. 
> 4. Give them a professional, yet friendly smile. You are going to need them soon. 

## FYI: Base `R` 

> - `R` without any packages offers ways to do most of the things we will see today. 
> - But base `R` is not a very good programming language. 
> - So, we will use....

## The Tidyverse

> "Programs must be written for people to read and only incidentally for machines to execute" 

- [*Hal Abelson*](https://en.wikipedia.org/wiki/Hal_Abelson)

The Tidyverse is a set of packages that promote code which is: 

- Easy to read and write
- Highly performant
- Consistent across the data science workflow

**When you master the Tidyverse, you spend more time thinking about your problem and less time thinking about your code.** 

## The Process of Data Science

![](http://r4ds.had.co.nz/diagrams/data-science.png)

# Getting Started

1. Data Import and Inspection
2. Data Subsetting
3. The Pipe

## Our Data Today

AirBnB listings, schedule, and review text for the Boston area, for a time period...that you will check. 

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
listings <- read_csv('../data/listings.csv')
calendar <- read_csv('../data/calendar.csv')
```

<!-- ## Warmup: The Nicest Places in JP -->

<!-- - **Question:** What are the "nicest" places to stay in Jamaica Plain?  -->
<!-- - **Task:** Construct a table of listings in JP, sorted in descending order by rating.  -->

<!-- Conceptually, we need to: `filter` to only JP listings, `arrange` the listings by rating, and `select` only the columns we want to see. Let's write some code!   -->

<!-- ## Two Subpar Solutions  -->

<!-- ```{r, eval = FALSE} -->
<!-- # wasteful -->
<!-- jp_only <- filter(listings, neighbourhood == 'Jamaica Plain') -->
<!-- sorted  <- arrange(jp_only, desc(review_scores_rating)) -->
<!-- concise <- select(sorted, neighbourhood, name, review_scores_rating)  -->
<!-- concise -->
<!-- ``` -->

<!-- ```{r, eval = FALSE} -->
<!-- # unreadable -->
<!-- select( -->
<!-- 	arrange( -->
<!-- 		filter(listings, neighbourhood == 'Jamaica Plain'),  -->
<!-- 		desc(review_scores_rating) -->
<!-- 		),  -->
<!-- 	neighbourhood, name, review_scores_rating) -->
<!-- ``` -->

## The Pipe

```{r, echo = FALSE, out.height = 200, out.width = 200}
knitr::include_graphics('https://d21ii91i3y6o6h.cloudfront.net/gallery_images/from_proof/3632/small/1419844831/magrittr.png')
```

> - `x %>% f(y)` is equivalent to `f(x,y)`
> - "Take `x`, and then do `f(...,y)` to it"
> - `x %>% f(y) %>% g(z) %>% ` $ \equiv$ `g(f(x,y),z)` 

## Some Simple Examples

```{r, eval = FALSE}

# familiar
listings %>% glimpse() # equivalent to glimpse(listings)
listings %>% head()    # etc. 
listings %>% colnames()

# get all columns with "review_scores" in the column name
listings %>% select(contains('review_scores')) 
# what should this return? 
listings %>% select(contains('review_scores')) %>% colnames()
```

<!-- ## Exercise 1:  -->

<!-- Working with your partner, please rewrite the JP code using the pipe operator. Here's the first line to get you started: -->

<!-- ```{r, eval = FALSE} -->
<!-- listings %>%  -->
<!-- 	filter(neighbourhood == 'Jamaica Plain') -->
<!-- # ... -->
<!-- ``` -->

<!-- ## Exercise 1 Sample Code {.smaller} -->

<!-- ```{r, eval = FALSE} -->
<!-- listings %>%  -->
<!-- 	filter(neighbourhood == 'Jamaica Plain') %>%      # filter needs a logical test -->
<!-- 	arrange(desc(review_scores_rating)) %>%           # desc() makes descending order  -->
<!-- 	select(neighbourhood, name, review_scores_rating) -->
<!-- ``` -->

<!-- ## Exercise 1 Sample Output -->

<!-- ```{r, echo = FALSE} -->
<!-- listings %>%  -->
<!-- 	filter(neighbourhood == 'Jamaica Plain') %>%      # filter needs a logical test -->
<!-- 	arrange(desc(review_scores_rating)) %>%           # desc() makes descending order  -->
<!-- 	select(neighbourhood, name, review_scores_rating) %>% -->
<!-- 	DT::datatable(options = list(pageLength = 4))  -->
<!-- ``` -->


<!-- ## Exercise 2: The Biggest Place in Back Bay -->

<!-- You are going to spend a long weekend in Back Bay with 50 of your closest friends. -->

<!-- Working with your partner, modify your code slightly to construct a table of the listings in Back Bay, sorted by the number of people who can stay there. You may need to use `glimpse` to see which columns you'll want to use.  -->

<!-- ## Exercise 2: Sample Code -->

<!-- ```{r, eval = FALSE} -->
<!-- listings %>%  -->
<!-- 	filter(neighbourhood == 'Back Bay') %>%  -->
<!-- 	arrange(accommodates) %>%  -->
<!-- 	select(neighbourhood, name, accommodates, price) -->
<!-- ``` -->

<!-- ## Exercise 2: Sample Output -->

<!-- ```{r, echo = FALSE} -->
<!-- listings %>%  -->
<!-- 	filter(neighbourhood == 'Back Bay') %>%  -->
<!-- 	arrange(desc(accommodates)) %>%  -->
<!-- 	select(neighbourhood, name, accommodates, price)  %>% -->
<!-- 	DT::datatable(options = list(pageLength = 4))  -->
<!-- ``` -->

# Summarising Data

1. Summary Statistics
2. Adding Columns
3. Grouping

<!-- ## Exercise 3  -->

<!-- Modify the summary table as follows:  -->

<!-- 1. Group by property_type as well as neighborhood. How does this impact the output? -->
<!-- 2. Add a new column to the table with the average rate per person for WEEKLY rentals, using the weekly_price column.  -->
<!-- 3. Add a new column giving the total "capacity" for each neighborhood, given as the total number of beds in rentals in that neighborhood.  -->

<!-- ## Exercise 3 Sample Code {.smaller} -->

<!-- ```{r, warning = FALSE} -->
<!-- summary_table <- listings %>%  -->
<!-- 	mutate(price = price %>% gsub('\\$|', '',.) %>% as.numeric(), -->
<!-- 		   price_per = price / accommodates, -->
<!-- 		   weekly_price = weekly_price %>% gsub('\\$|', '',.) %>% as.numeric(), -->
<!-- 		   weekly_price_per = weekly_price / accommodates)  %>%  -->
<!-- 	group_by(neighbourhood, property_type) %>%  -->
<!-- 	summarize(n = n(),  -->
<!-- 			  mean_rating = mean(review_scores_rating, na.rm = TRUE), -->
<!-- 			  price_per = mean(price_per, na.rm = TRUE), -->
<!-- 			  weekly_price_per = mean(weekly_price_per, na.rm = T), -->
<!-- 			  capacity = sum(beds))  -->
<!-- ``` -->

<!-- ## Exercise 3 Sample Output {.smaller} -->

<!-- ```{r, echo = FALSE} -->
<!-- summary_table %>% -->
<!-- 	DT::datatable(options = list(pageLength = 5)) %>%  -->
<!-- 	DT::formatRound(c('mean_rating', 'price_per', 'weekly_price_per'), 1) -->
<!-- ``` -->

<!-- ## Exercise 4 {.smaller} -->

<!-- If you check `summary_table`, you'll notice that it has exactly one grouping column: `neighbourhood`. Working with your partner,  -->

<!-- 1. Explain why there is just one grouping column when we made two groups in Exercise 3.  -->
<!-- 2. Use `mutate` to construct a `rank` column where the top-ranked row has the highest value of `n` (i.e. most popular type). You might want the `min_rank` function and the `desc` function we used when sorting. What behavior do you observe? -->
<!-- 3. Filter to include only rows of rank 3 or less.  -->
<!-- 3. Sort the rows in descending order by `n` using `arrange`. What behavior do you observe now? See if you can get the table sorted in descending order by rank, while keeping neighbourhoods grouped together.  -->

<!-- ## Exercise 4 Sample Code -->

<!-- ```{r} -->
<!-- ranked_summary_table <- summary_table %>%  -->
<!-- 	mutate(rank = min_rank(desc(n))) %>%  -->
<!-- 	filter(rank <= 3) %>%  -->
<!-- 	arrange(neighbourhood, rank) -->
<!-- ``` -->

<!-- ## Exercise 4 Sample Output {.smaller} -->

<!-- ```{r, echo = FALSE} -->
<!-- ranked_summary_table %>% -->
<!-- 	DT::datatable(options = list(pageLength = 5)) %>%  -->
<!-- 	DT::formatRound(c('mean_rating', 'price_per', 'weekly_price_per'), 1) -->
<!-- ``` -->

# Keeping Current

1. More practice with `filter` and `summarise`
2. `join`ing data


## How Current Is This Info?

```{r}
calendar %>% 
	summarise(earliest = min(date), 
		   latest = max(date))
```

Pretty current. But what if we want to focus on listings that have been active in the last three months? 

Schematically: 

1. Operate on the `calendar` table (exercise)
2. `join` that information to the `listings` table (together)
3. Filter the listings table accordingly (together)

<!-- ## Exercise -->

<!-- Construct a table from the `calendar` data giving the listings that had a valid listed date between June 1st, 2016 and today. You determine what "valid" means in this context.  -->

<!-- *Hint:* You can represent a date using the function  -->

<!-- ```{r} -->
<!-- lubridate::mdy('6/1/2016') -->
<!-- ``` -->

<!-- You can also use `lubridate::today()`. You can use `max()` to get the most recent date. -->

<!-- ## Sample Solution: Code -->

<!-- ```{r,  echo = TRUE} -->
<!-- current_table <- calendar %>%  -->
<!-- 	filter(!is.na(price),  -->
<!-- 		   date < lubridate::today(), -->
<!-- 		   date > lubridate::mdy('6/1/2016')) %>% -->
<!-- 	group_by(listing_id) %>%  -->
<!-- 	summarise(last_active = max(date)) -->
<!-- ``` -->

<!-- ## Sample Solution: Output -->


<!-- ```{r, echo = FALSE} -->
<!-- current_table %>%  -->
<!-- 	DT::datatable(options = list(pageLength = 5)) -->
<!-- ``` -->

## Relational Data

The information we need is distributed between two tables -- how can we get there? 

We need a key that tells us which `calendar` rows correspond to which `listings`. 

> `listings$id` corresponds to `calendar_listing$id`

## `join` 

The `join` family of functions lets us add columns from one table to another using a key. 
- `x %>% left_join(y)`  : most common, keeps all rows of `x` but not necessarily `y`. 
- `x %>% right_join(y)` : keeps all rows of `y` but not necessarily `x`.  
- `x %>% outer_join(y)` : keeps all rows of both `x` and `y`
- `x %>% full_join(y)` : keeps only rows of `x` that match in `y` and vice versa. 

We'll use `left_join` for this case. But first, the exercise! 

# Getting Visual

1. Graphical Excellence
2. The Grammar of Graphics
3. Wrangling and Visualization

## Graphical Excellence

> Graphical excellence is the well-designed presentation of interesting data -- a matter of *substance*, of *statistics*, and of *design*. Graphical excellence consists of complex ideas communicated with clarity, precision, and efficiency. -- *Edward Tufte*

## The Grammar of Graphics

A **grammar** is a set of components (ingredients) that you can combine to create new things. Many grammars have **required components**: if you're missing one, you're doing it wrong. In baking....

<div class="columns-2">

- **A body** -- typically some kind of flour)
- **Binder** -- eggs, oil, butter, or applesauce
- **A rising agent** -- yeast, baking soda, baking powder
- **Flavoring** -- sugar, salt, chocolate, vanilla

```{r, out.height = 200, fig.retina = NULL, echo = FALSE}
knitr::include_graphics("http://www.hoteliermiddleeast.com/pictures/640x422/pastry-1-web.jpg")
```

</div>

## The Grammar of Graphics

- Puts the `gg` in `ggplot2`. 
- Formulated by Leland Wilkinson.
- Implemented in code by Hadley Wickham, now part of the `tidyverse`

<div class="columns-2">
```{r, out.height = 400, fig.retina = NULL, echo = FALSE}
knitr::include_graphics("http://ecx.images-amazon.com/images/I/41ZIHtc9TJL._SX327_BO1,204,203,200_.jpg")
```

```{r, out.height = 400, fig.retina = NULL, echo = FALSE}
knitr::include_graphics("http://pix-media.s3.amazonaws.com/blog/1001/HadleyObama2.png")
```
</div>

## Ingredients of a data visualization {.smaller}

- **`Data`**:  almost always a `data_frame` 
- **`Aes`**thetic mapping: relation of data to chart components.
- **`Geom`**etry: specific visualization type? E.g. line, bar, heatmap?
- **`Stat`**istical transformation: how should the data be transformed or aggregated before visualizing?
- **`Theme`**: how should the non-data parts of the plot look?
- Misc. other options. 

`+` plays the same role in `ggplot2` that `%>%` does in data manipulation.

## First Plot {.smaller}

Does getting **lots** of reviews usually mean you get **good** reviews? 

```{r, warning = FALSE, out.width = 600}
listings %>% 
	ggplot()
```

## First Plot {.smaller}

```{r, warning = FALSE, out.width = 600}
listings %>% 
	ggplot() + 
	aes(x = number_of_reviews, y = review_scores_rating)
```

## First Plot {.smaller}

```{r, warning = FALSE, out.width = 600}
listings %>% 
	ggplot() + 
	aes(x = number_of_reviews, y = review_scores_rating) + 
	geom_point()
```

## First Plot {.smaller}

```{r, warning = FALSE, out.width = 600}
listings %>% 
	ggplot() + 
	aes(x = number_of_reviews, y = review_scores_rating) + 
	geom_point(alpha = .2) 
```

## First Plot {.smaller}

```{r, warning = FALSE, out.width = 600}
listings %>% 
	ggplot() + 
	aes(x = number_of_reviews, y = review_scores_rating) + 
	geom_point(alpha = .2) + 
	theme_bw()
```

## First Plot {.smaller}

```{r, warning = FALSE, out.width = 500, out.height=300}
listings %>% 
	### <b>
	filter(number_of_reviews < 100) %>%
	### </b>
	ggplot() + 
	aes(x = number_of_reviews, y = review_scores_rating) + 
	geom_point(alpha = .2) + 
	theme_bw() 
```

## First Plot {.smaller}

```{r, warning = FALSE, out.width = 500, out.height=300}
listings %>% 
	filter(number_of_reviews < 100) %>%
	ggplot() + 
	aes(x = number_of_reviews, y = review_scores_rating) + 
	geom_point(alpha = .2) + 
	theme_bw() + 
	labs(x='Number of Reviews', y='Review Score', title='Review Volume and Review Quality') 
```

## First Plot {.smaller}

```{r, warning = FALSE, out.width = 500, out.height=300}
listings %>% 
	filter(number_of_reviews < 100) %>%
	ggplot() + 
	aes(x = number_of_reviews, y = review_scores_rating) + 
	### <b>
	geom_point(alpha = .2, color = 'firebrick') + 
	### </b>
	theme_bw() + 
	labs(x='Number of Reviews', y='Review Score',title='Review Volume and Review Quality') 
```

## Changing It Up {.smaller}

```{r, warning = FALSE, out.width = 500, out.height=300}
listings %>% 
	filter(number_of_reviews < 100) %>%
	ggplot() + 
	### <b>
	aes(x = review_scores_value, 
		y = review_scores_location, 
		size = number_of_reviews) + 
	### </b>
	geom_point(alpha = .2, color = 'firebrick') + 
	theme_bw() 
```

## As a Heatmap {.smaller}

```{r, warning = FALSE, out.width = 500, out.height=300}
listings %>% 
	filter(number_of_reviews < 100) %>%
	ggplot() + 
	aes(x = review_scores_value, 
		y = review_scores_location, 
	### <b>
		fill = number_of_reviews) + 
	geom_tile() + 
	### </b>
	theme_bw() 
```

## Exercise 6

The following code computes the average price of all listings on each day in the data set:
```{r, warning = FALSE}
average_price_table <- calendar %>% 
	mutate(price = price %>% gsub('\\$|', '',.) %>% as.numeric()) %>% 
	group_by(date) %>% 
	summarise(mean_price = mean(price, na.rm = TRUE))
```

Use `geom_line()` to visualize these prices with time on the `x`-axis and price on the `y`-axis. 

## Exercise 6 Sample Solution

```{r,  out.width = 500, out.height=300}
 average_price_table %>% 
	ggplot() + 
	aes(x = date, y = mean_price) + 
	geom_line()
```

## Exercise 7

```{r, warning = FALSE, echo = FALSE}

current_table <- calendar %>% 
	filter(!is.na(price), 
		   date < lubridate::today(),
		   date > lubridate::mdy('6/1/2016')) %>%
	group_by(listing_id) %>% 
	summarise(last_active = max(date))

recent_listings <- listings %>% 
	left_join(current_table, by = c('id' = 'listing_id')) %>% 
	filter(last_active > lubridate::mdy('6/1/2016'))

summary_table <- recent_listings %>% 
	mutate(price = price %>% gsub('\\$|', '',.) %>% as.numeric(),
		   price_per = price / accommodates,
		   weekly_price = weekly_price %>% gsub('\\$|', '',.) %>% as.numeric(),
		   weekly_price_per = weekly_price / accommodates)  %>% 
	group_by(neighbourhood, property_type) %>% 
	summarize(n = n(), 
			  mean_rating = mean(review_scores_rating, na.rm = TRUE),
			  price_per = mean(price_per, na.rm = TRUE),
			  weekly_price_per = mean(weekly_price_per, na.rm = T),
			  capacity = sum(beds)) %>% 
	ungroup()
```

Using the `summary_table` object you created earlier, make a bar chart showing the number of **apartments** by neighbourhood. In this case, the correct `geom` to use is `geom_bar(stat = 'identity')`. 

## Exercise 7 Sample Solution {.smaller}

```{r, warning = FALSE, out.width = 500, out.height = 300}
summary_table %>% 
	filter(property_type == 'Apartment') %>% 
	ggplot() + 
	aes(x = neighbourhood, y= n) + 
	geom_bar(stat = 'identity')
```

## Let's Clean This Up a Bit {.smaller}

```{r, warning = FALSE, out.width = 500, out.height = 300}
summary_table %>% 
	filter(property_type == 'Apartment') %>% 
	ggplot() + 
	###<b>
	aes(x = reorder(neighbourhood, n), y=n) + 
	coord_flip() + 
	###</b>
	geom_bar(stat = 'identity')
```

# Comparisons: Fill, Color, and Facets

## From Exercise 7 {.smaller}
```{r, warning = FALSE,  out.width = 500, out.height=300}
summary_table %>% 
	ggplot() + 
	###<b>
	aes(x = reorder(neighbourhood, n), y=n, fill = property_type) + 
	###</b>
	coord_flip() + 
	geom_bar(stat = 'identity') 
```

## From Our First Plot {.smaller}
```{r, warning = FALSE,  out.width = 500, out.height=300}
listings %>% 
	filter(number_of_reviews < 100) %>%
	ggplot() + 
	### <b>
	aes(x = number_of_reviews, y = review_scores_rating, color = property_type) + 
	### </b>
	geom_point(alpha = .5) + 
	theme_bw() + 
	labs(x='Number of Reviews', y='Review Score', title='Review Volume and Review Quality') 
```

## From Our First Plot {.smaller}
```{r, warning = FALSE,  out.width = 500, out.height=300}
listings %>% 
	filter(number_of_reviews < 100) %>%
	ggplot() + 
	aes(x = number_of_reviews, y = review_scores_rating, color = property_type) + 
	geom_point(alpha = .5) + 
	theme_bw() + 
	### <b>
	facet_wrap(~property_type) + 
	### </b>
	labs(x='Number of Reviews', y='Review Score', title='Review Volume and Review Quality') 
```

## Optional: Score Types {.smaller}

```{r, warning = FALSE,  out.width = 500, out.height=300}
listings %>% 
	select(number_of_reviews, contains("review_scores"), - review_scores_rating) %>% 
	###<b> 
	gather(key = type, value = score, -number_of_reviews) %>% 
	###</b> 
	ggplot() + 
	aes(x = factor(score), y = number_of_reviews) + 
	geom_boxplot() + 
	facet_wrap(~type)
```

# Mini-Project

## Project Description

We are going to make a simple business intelligence (BI) dashboard for AirBnB, using the wrangling and visualization skills we have developed in this session. You will use this dashboard to lead a meeting with decision-makers on where to prioritize host recruitment efforts. 

[Example Output](https://philchodrow.github.io/data_science_intro/wrangle_viz/dashboard.html)

## Instructions {.smaller}

1. Please open `wrangle_viz/dashboard.Rmd`
2. Click the `knit` button at the top of RStudio and observe the result. If you see a dashboard, then are good to go. 
3. Modify the dashboard: 
	- Include your names in the `author` metadata up top
	- Write code for data preparation and visualizations as appropriate. You should aim to include a main visualization and a supporting one. 
	- Include all your code in the `R` "code chunks" that begin with ````{r}`
	- Add commentary in the indicated area
4. Once you are done, `knit` the dashboard one last time and place it in the shared Dropbox folder. 
	
## You are done iff 

1. You have added your names to the dashboard
2. You have replaced "Box 1", "Box 2", and "Box 3" with informative subtitles
3. You have created two original visualizations aimed at supporting a clear message about where AirBnB should recruit hosts. 
4. You have written brief commentary clarifying your message. 
5. You have submitted your dashboard to the shared Dropbox. 

# Additional Resources

## Visualization Problems are Wrangling Problems

> "In my experience, the vast majority of graphing agony is due to insufficient data wrangling." - [Jenny Bryan](http://stat545.com/cm006_tibbles-dplyr-ggplot2.html)

## Additional Resources

- Data Wrangling [Cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf)

## Map of the Tidyverse

```{r, echo = FALSE, out.width = "700px"}
knitr::include_graphics("https://rviews.rstudio.com/post/2017-06-09-What-is-the-tidyverse_files/tidyverse1.png")
```





